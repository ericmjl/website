{% extends "layout.html" %}
{% block title %}{{ this.title }}{% endblock %}

{% block body %}
<h1>{{ this.title }}</h1>

<p>
    I believe in open source as a way to give back to the community and collaborate with others.
    Here's a view of my open source activity.
</p>

<!-- What I'm Working On Now -->
<section id="recent-activity">
    <h2>What I'm Working On Now</h2>
    <p class="section-subtitle">Live activity from GitHub</p>
    <div id="activity-container" class="loading">
        <p>Loading recent activity...</p>
    </div>
</section>

<!-- Projects I Maintain -->
<section id="maintained-projects">
    <h2>Projects I Maintain</h2>
    <p class="section-subtitle">Open source projects I created or help maintain</p>
    <div id="projects-container" class="loading">
        <p>Loading projects...</p>
    </div>
</section>

<!-- Contributions to Other Projects -->
<section id="contributions">
    <h2>Contributions to Other Projects</h2>
    <p class="section-subtitle">Pull requests to projects I don't maintain (last 12 months)</p>
    <div id="contributions-container" class="loading">
        <p>Loading contributions...</p>
    </div>
</section>

<p class="data-timestamp" id="data-timestamp"></p>

<script>
(function() {
    'use strict';

    const GITHUB_USERNAME = 'ericmjl';

    // Fetch live activity directly from GitHub API
    async function fetchLiveActivity() {
        try {
            const response = await fetch(`https://api.github.com/users/${GITHUB_USERNAME}/events/public?per_page=100`);
            if (!response.ok) throw new Error('Failed to fetch GitHub events');
            const events = await response.json();

            // Process events into activity summary
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - 30);

            const repoActivity = {};

            for (const event of events) {
                const eventTime = new Date(event.created_at);
                if (eventTime < cutoff) continue;

                if (event.type === 'PushEvent') {
                    const repo = event.repo.name;
                    const payload = event.payload;
                    const commits = payload.commits || [];
                    const commitCount = commits.length || payload.size || 1;

                    if (!repoActivity[repo]) {
                        repoActivity[repo] = {
                            repo: repo,
                            repo_url: `https://github.com/${repo}`,
                            commit_count: 0,
                            last_commit_date: event.created_at,
                            commits: []
                        };
                    }

                    repoActivity[repo].commit_count += commitCount;

                    // Collect commit messages
                    for (const commit of commits.slice(0, 3)) {
                        repoActivity[repo].commits.push({
                            message: commit.message.split('\n')[0],
                            sha: commit.sha.substring(0, 7)
                        });
                    }
                }
            }

            // Convert to sorted array
            const activity = Object.values(repoActivity)
                .sort((a, b) => b.commit_count - a.commit_count)
                .slice(0, 10);

            // Trim commits to 5 per repo
            for (const item of activity) {
                item.commits = item.commits.slice(0, 5);
            }

            renderRecentActivity(activity);
        } catch (error) {
            console.error('Error fetching live activity:', error);
            document.getElementById('activity-container').innerHTML =
                '<p class="error">Failed to load live activity. GitHub API may be rate-limited.</p>';
        }
    }

    // Fetch pre-built data for projects and contributions
    async function loadPrebuiltData() {
        try {
            const response = await fetch('/static/data/github-data.json');
            if (!response.ok) throw new Error('Failed to load GitHub data');
            const data = await response.json();

            renderMaintainedProjects(data.maintained_projects);
            renderContributions(data.contributions);

            // Show timestamp for pre-built data
            const timestamp = new Date(data.generated_at);
            document.getElementById('data-timestamp').textContent =
                `Project and contribution data last updated: ${timestamp.toLocaleDateString()} ${timestamp.toLocaleTimeString()}`;
        } catch (error) {
            console.error('Error loading pre-built data:', error);
            document.getElementById('projects-container').innerHTML =
                '<p class="error">Failed to load project data. Please try refreshing the page.</p>';
            document.getElementById('contributions-container').innerHTML =
                '<p class="error">Failed to load contribution data. Please try refreshing the page.</p>';
        }
    }

    function renderRecentActivity(activity) {
        const container = document.getElementById('activity-container');
        if (!activity || activity.length === 0) {
            container.innerHTML = '<p>No recent activity found.</p>';
            return;
        }

        const html = activity.map(item => `
            <div class="activity-item">
                <div class="activity-header">
                    <a href="${item.repo_url}" class="activity-repo">${item.repo}</a>
                    <span class="activity-count">${item.commit_count} commit${item.commit_count !== 1 ? 's' : ''}</span>
                </div>
                ${item.commits && item.commits.length > 0 ? `
                <ul class="activity-commits">
                    ${item.commits.slice(0, 3).map(c => `
                        <li><code>${c.sha}</code> ${escapeHtml(c.message)}</li>
                    `).join('')}
                </ul>
                ` : ''}
            </div>
        `).join('');

        container.innerHTML = html;
        container.classList.remove('loading');
    }

    function renderMaintainedProjects(projects) {
        const container = document.getElementById('projects-container');
        if (!projects || projects.length === 0) {
            container.innerHTML = '<p>No projects found.</p>';
            return;
        }

        const html = `
            <div class="projects-grid">
                ${projects.map(project => `
                    <div class="project-card">
                        <div class="project-header">
                            <a href="${project.url}" class="project-name">${project.name}</a>
                            <span class="project-language">${project.language || 'N/A'}</span>
                        </div>
                        <p class="project-description">${escapeHtml(project.description || 'No description')}</p>
                        <div class="project-stats">
                            <span class="stat" title="Stars">&#9733; ${formatNumber(project.stars)}</span>
                            <span class="stat" title="Forks">&#127860; ${formatNumber(project.forks)}</span>
                            <span class="stat" title="Open Issues">&#128203; ${project.open_issues}</span>
                        </div>
                        <div class="project-topics">
                            ${(project.topics || []).slice(0, 5).map(t => `<span class="topic">${t}</span>`).join('')}
                        </div>
                        <div class="project-updated">
                            Last updated: ${formatDate(project.pushed_at)}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        container.innerHTML = html;
        container.classList.remove('loading');
    }

    function renderContributions(contributions) {
        const container = document.getElementById('contributions-container');
        if (!contributions || contributions.length === 0) {
            container.innerHTML = '<p>No contributions found.</p>';
            return;
        }

        const html = `
            <div class="contributions-list">
                ${contributions.map(contrib => `
                    <div class="contribution-item">
                        <div class="contribution-header">
                            <span class="contribution-repo">${contrib.repo}</span>
                            <span class="contribution-stats">
                                ${contrib.prs.length} PR${contrib.prs.length !== 1 ? 's' : ''}
                                ${contrib.merged_count > 0 ? `(${contrib.merged_count} merged)` : ''}
                            </span>
                        </div>
                        <ul class="contribution-prs">
                            ${contrib.prs.slice(0, 3).map(pr => `
                                <li>
                                    <a href="${pr.url}" class="pr-link ${pr.state}">
                                        ${escapeHtml(pr.title)}
                                    </a>
                                    <span class="pr-state pr-${pr.state}">${pr.merged ? 'merged' : pr.state}</span>
                                </li>
                            `).join('')}
                            ${contrib.prs.length > 3 ? `<li class="more-prs">+ ${contrib.prs.length - 3} more</li>` : ''}
                        </ul>
                    </div>
                `).join('')}
            </div>
        `;

        container.innerHTML = html;
        container.classList.remove('loading');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatNumber(num) {
        if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'k';
        }
        return num.toString();
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'Unknown';
        const date = new Date(dateStr);
        const now = new Date();
        const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) > 1 ? 's' : ''} ago`;
        if (diffDays < 365) return `${Math.floor(diffDays / 30)} month${Math.floor(diffDays / 30) > 1 ? 's' : ''} ago`;
        return date.toLocaleDateString();
    }

    // Load data when DOM is ready
    function init() {
        // Fetch live activity from GitHub API
        fetchLiveActivity();
        // Load pre-built data for projects and contributions
        loadPrebuiltData();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
{% endblock %}
